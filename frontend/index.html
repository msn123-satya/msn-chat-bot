<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>AI Chatbot</title>

  <!-- Marked.js for Markdown -->
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

  <!-- Highlight.js for Code Highlighting -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/github.min.css">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>

  <style>
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    }

    body {
      background-color: #f7f8fa;
      color: #000;
      display: flex;
      flex-direction: column;
      height: 100vh;
      overflow: hidden;
    }

    .container {
      display: flex;
      flex-direction: column;
      height: 100vh;
      max-width: 900px;
      margin: 0 auto;
      width: 100%;
      padding: 0 15px;
    }

    h1 {
      padding: 20px 0;
      color: #222;
      text-align: center;
      background-color: #f7f8fa;
      position: sticky;
      top: 0;
      z-index: 10;
    }

    #chatbox {
      flex: 1;
      overflow-y: auto;
      background: #f0f2f5;
      padding: 25px;
      border-radius: 12px 12px 0 0;
      box-shadow: 0 0 15px rgba(0, 0, 0, 0.1);
      display: flex;
      flex-direction: column;
      border: 1px solid #ddd;
      border-bottom: none;
    }

    .message {
      max-width: 95%;
      margin-bottom: 15px;
      padding: 15px;
      border-radius: 10px;
      line-height: 1.6;
      word-wrap: break-word;
      white-space: pre-wrap;
      position: relative;
    }

    .user {
      align-self: flex-end;
      background-color: #0078ff;
      color: white;
    }

    .bot {
      align-self: flex-start;
      background-color: #f0f2f5;
      color: #000;
    }

    .input-container {
      display: flex;
      background: #fff;
      padding: 20px 25px;
      border-radius: 0 0 12px 12px;
      box-shadow: 0 0 15px rgba(0, 0, 0, 0.1);
      border: 1px solid #ddd;
      border-top: none;
      position: sticky;
      bottom: 0;
      z-index: 10;
    }

    .input-wrapper {
      flex: 1;
      position: relative;
      display: flex;
      align-items: center;
    }

    input {
      flex: 1;
      padding: 14px 50px 14px 14px;
      border: 1px solid #ccc;
      border-radius: 8px;
      font-size: 16px;
    }

    .voice-btn {
      position: absolute;
      right: 10px;
      background: none;
      border: none;
      cursor: pointer;
      padding: 8px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.3s ease;
    }

    .voice-btn:hover {
      background-color: #f0f2f5;
    }

    .voice-btn.listening {
      background-color: #ff4444;
      color: white;
    }

    .voice-btn.listening:hover {
      background-color: #cc3333;
    }

    .send-btn {
      padding: 14px 20px;
      border: none;
      background-color: #0078ff;
      color: white;
      font-size: 16px;
      cursor: pointer;
      border-radius: 8px;
      margin-left: 10px;
    }

    .send-btn:hover {
      background-color: #005bb5;
    }

    pre {
      background-color: #f5f5f5;
      padding: 0px;
      border-radius: 6px;
      overflow-x: auto;
      font-size: 14px;
      color: #111;
      position: relative;
    }

    .copy-btn {
      position: absolute;
      top: 12px;
      right: 12px;
      background-color: white;
      border: 1px solid #ddd;
      border-radius: 20px;
      cursor: pointer;
      font-size: 12px;
      color: #666;
      display: flex;
      align-items: center;
      gap: 0px;
      transition: all 0.2s ease;
    }

    .copy-btn:hover {
      background-color: #e9ecef;
      color: #333;
    }

    .copy-btn.copied {
      color: #28a745;
      border-color: #28a745;
    }

    code {
      font-family: Consolas, monospace;
    }

    blockquote {
      border-left: 4px solid #ccc;
      padding-left: 12px;
      color: #555;
      margin: 10px 0;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      margin: 10px 0;
    }

    th, td {
      padding: 10px;
      border: 1px solid #ccc;
    }

    th {
      background-color: #eee;
    }

    a {
      color: #0078ff;
      text-decoration: underline;
    }

    .mic-icon {
      width: 20px;
      height: 20px;
      fill: #666;
    }

    .voice-btn.listening .mic-icon {
      fill: white;
    }

    .check-icon {
      width: 20px;
      height: 20px;
      fill: #666;
    }

    .voice-btn.listening .check-icon {
      fill: white;
    }

    .copy-icon {
      width: 19px;
      height: 16px;
      fill: currentColor;
    }
  </style>
</head>
<body>

  <div class="container">
    <h1>ðŸ¤– AI Chatbot</h1>
    <div id="chatbox"></div>

    <div class="input-container">
      <div class="input-wrapper">
        <input type="text" id="userInput" placeholder="Type a message or use voice..." autofocus>
        <button class="voice-btn" id="voiceBtn" onclick="toggleVoiceRecording()">
          <svg class="mic-icon" viewBox="0 0 24 24">
            <path d="M12 14c1.66 0 3-1.34 3-3V5c0-1.66-1.34-3-3-3S9 3.34 9 5v6c0 1.66 1.34 3 3 3z"/>
            <path d="M17 11c0 2.76-2.24 5-5 5s-5-2.24-5-5H5c0 3.53 2.61 6.43 6 6.92V21h2v-3.08c3.39-.49 6-3.39 6-6.92h-2z"/>
          </svg>
          <svg class="check-icon" viewBox="0 0 24 24" style="display: none;">
            <path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"/>
          </svg>
        </button>
      </div>
      <button class="send-btn" onclick="sendMessage()">Send</button>
    </div>
  </div>

  <script>
    document.addEventListener("DOMContentLoaded", () => {
      let chatbox = document.getElementById("chatbox");
      let isListening = false;
      let recognition = null;

      // Initialize Speech Recognition
      if ('webkitSpeechRecognition' in window || 'SpeechRecognition' in window) {
        const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
        recognition = new SpeechRecognition();
        recognition.continuous = true;
        recognition.interimResults = false;
        recognition.lang = 'en-US';

        recognition.onstart = function() {
          isListening = true;
          updateVoiceButton();
        };

        recognition.onresult = function(event) {
          let transcript = '';
          for (let i = event.resultIndex; i < event.results.length; i++) {
            transcript += event.results[i][0].transcript;
          }
          document.getElementById('userInput').value += transcript;

        };

        recognition.onend = function() {
          isListening = false;
          updateVoiceButton();
        };

        recognition.onerror = function(event) {
          isListening = false;
          updateVoiceButton();
          console.error('Speech recognition error:', event.error);
        };
      }

      function updateVoiceButton() {
        const voiceBtn = document.getElementById('voiceBtn');
        const micIcon = voiceBtn.querySelector('.mic-icon');
        const checkIcon = voiceBtn.querySelector('.check-icon');
        
        if (isListening) {
          voiceBtn.classList.add('listening');
          micIcon.style.display = 'none';
          checkIcon.style.display = 'block';
          voiceBtn.title = 'Click to stop recording';
        } else {
          voiceBtn.classList.remove('listening');
          micIcon.style.display = 'block';
          checkIcon.style.display = 'none';
          voiceBtn.title = 'Click to start voice input';
        }
      }

      window.toggleVoiceRecording = function() {
        if (!recognition) {
          alert('Speech recognition is not supported in your browser.');
          return;
        }

        if (isListening) {
          recognition.stop();
        } else {
          recognition.start();
        }
      };

      function addCopyButtons() {
        const preElements = chatbox.querySelectorAll('pre:not([data-copy-added])');
        preElements.forEach(pre => {
          pre.setAttribute('data-copy-added', 'true');
          const copyBtn = document.createElement('button');
          copyBtn.className = 'copy-btn';
          copyBtn.innerHTML = `
            <svg class="copy-icon" viewBox="0 0 24 24">
              <path d="M16 1H4c-1.1 0-2 .9-2 2v14h2V3h12V1zm3 4H8c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h11c1.1 0 2-.9 2-2V7c0-1.1-.9-2-2-2zm0 16H8V7h11v14z"/>
            </svg>   Copy`;
          
          copyBtn.onclick = function() {
            const code = pre.querySelector('code') || pre;
            navigator.clipboard.writeText(code.textContent).then(() => {
              copyBtn.innerHTML = `
                <svg class="copy-icon" viewBox="0 0 24 24">
                  <path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"/>
                </svg>   Copied!`;
              copyBtn.classList.add('copied');
              
              setTimeout(() => {
                copyBtn.innerHTML = `
                  <svg class="copy-icon" viewBox="0 0 24 24">
                    <path d="M16 1H4c-1.1 0-2 .9-2 2v14h2V3h12V1zm3 4H8c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h11c1.1 0 2-.9 2-2V7c0-1.1-.9-2-2-2zm0 16H8V7h11v14z"/>
                  </svg>   Copy`;
                copyBtn.classList.remove('copied');
              }, 2000);
            }).catch(err => {
              console.error('Failed to copy: ', err);
            });
          };
          
          pre.style.position = 'relative';
          pre.appendChild(copyBtn);
        });
      }

      async function sendMessage() {
        let userMessage = document.getElementById("userInput").value.trim();
        if (!userMessage) {
          alert("Please enter your query.");
          return;
        }

        // Add user message
        let userBubble = document.createElement("div");
        userBubble.classList.add("message", "user");
        userBubble.innerText = userMessage;
        chatbox.appendChild(userBubble);
        document.getElementById("userInput").value = "";
        chatbox.scrollTop = chatbox.scrollHeight;

        try {
          let response = await fetch("http://127.0.0.1:8000/chat/", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ text: userMessage })
          });

          if (response.ok) {
            let data = await response.json();
            let botBubble = document.createElement("div");
            botBubble.classList.add("message", "bot");

            // Convert Markdown to HTML
            botBubble.innerHTML = marked.parse(data.reply || '', { gfm: true, breaks: true });

            // Highlight code inside the response
            chatbox.appendChild(botBubble);
            hljs.highlightAll();
            
            // Add copy buttons to new code blocks
            addCopyButtons();
          } else {
            let errorBubble = document.createElement("div");
            errorBubble.classList.add("message", "bot");
            errorBubble.innerText = "Error: " + response.status;
            chatbox.appendChild(errorBubble);
          }
        } catch (error) {
          let errorBubble = document.createElement("div");
          errorBubble.classList.add("message", "bot");
          errorBubble.innerText = "Server not responding.";
          chatbox.appendChild(errorBubble);
        }

        chatbox.scrollTop = chatbox.scrollHeight;
      }

      window.sendMessage = sendMessage;

      document.getElementById("userInput").addEventListener("keypress", function (event) {
        if (event.key === "Enter") {
          event.preventDefault();
          sendMessage();
        }
      });
    });
  </script>

</body>
</html>